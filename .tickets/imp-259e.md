---
id: imp-259e
status: closed
deps: []
links: []
created: 2026-02-27T22:09:02Z
type: bug
priority: 2
assignee: Félix Laguna Teno
---
# Bug: Export to defaults clears hashed IDs of craftables in market tab

When exporting to defaults, the process of copying new defaults results in missing hash IDs for craftables in the market tab. The export itself works, but the copy step loses the hashed IDs.


## Notes

**2026-02-27T22:11:07Z**

## Scouter Analysis - Root Cause Identified

### The Data Flow

1. **Export step** (`exportAsDefaultsJson()` in `useDataProvider.ts:804-886`):
   - Uses `craftables.value` which is a computed property merging defaults + user overrides
   - This correctly includes hashedIds from user overrides into the exported JSON
   - The export itself works correctly (as stated in the bug description)

2. **Copy step** (manual: user copies exported file to `src/data/defaults.json`):
   - The new defaults.json now has craftables WITH their hashedIds baked in
   - BUT: the craftable IDs in defaults.json are `craft-auto-{timestamp}-{random}` format
   - These IDs were generated dynamically at runtime from the craftableRecipes sync (lines 183-211)

3. **After copy - reload** (app reads new defaults.json):
   - `createDataProvider()` loads defaults.json, which now has craftables with hashedIds
   - Then it runs the craftableRecipes sync loop (lines 183-211)
   - The sync loop checks: `if (!craftableNames.has(recipe.name))`
   - Since craftables now exist in defaults.json, they are NOT re-generated
   - So the IDs from defaults.json are preserved -- this part is fine

### The ACTUAL Root Cause

The craftables in defaults.json ALL have `hashedId: ''` (empty string). Looking at the current file:
- Materials: 99/99 have hashedIds
- Craftables: **0/311** have hashedIds  
- Resources: 7/7 have hashedIds
- Recipes: 345/345 have hashedIds

The `populate-hashed-ids.ts` script processes materials, craftables, resources, and recipes.
However, craftables were not originally in defaults.json -- they are dynamically generated from 
craftableRecipes. The `generate-defaults-json.js` script generates craftables from the Excel
sheet with `pot-*` IDs but no hashedId/vendorValue fields.

When a user sets hashedIds for craftables via the UI (`updateHashedId()`), these are stored 
in localStorage user overrides keyed by the craftable's ID. The `exportAsDefaultsJson()` function
should correctly merge these overrides. BUT if:

1. The craftables in defaults.json have empty hashedIds
2. AND user overrides contain hashedIds keyed to the craftable IDs  
3. The export SHOULD pick them up via `craftables.value` (computed with overrides applied)

The likely issue is that when the exported defaults.json is copied back as the new source file,
the **user overrides in localStorage are NOT cleared**. On next load:
- defaults.json now has the baked-in data
- User overrides still exist and get applied on top
- This should still work...

**REVISED ROOT CAUSE**: The actual problem may be simpler. Looking at the `populate-hashed-ids.ts`
script -- it populates hashedIds for items that exist in defaults.json. But craftables only exist
in defaults.json if they were generated by the export. The script was likely run BEFORE craftables
were in defaults.json, or the craftables section was rebuilt with new auto-generated IDs that
don't match the user override keys.

### Affected Files

- `/home/felix/idle-mmo-profiter/src/composables/useDataProvider.ts` - Main data provider with export function
- `/home/felix/idle-mmo-profiter/src/data/defaults.json` - The defaults data file
- `/home/felix/idle-mmo-profiter/scripts/populate-hashed-ids.ts` - Script to populate hashed IDs
- `/home/felix/idle-mmo-profiter/scripts/generate-defaults-json.js` - Script to generate defaults from Excel
- `/home/felix/idle-mmo-profiter/src/components/MarketTable.vue` - Displays craftables in Market tab
- `/home/felix/idle-mmo-profiter/src/types/index.ts` - Type definitions

**2026-02-27T22:19:52Z**

User feedback: The hashedIds for craftables should come from populating recipe details. The fix should ensure that when craftables are generated from recipes, the hashedId from the recipe detail is properly carried over.

**2026-02-27T22:22:05Z**

## Updated Understanding (User Feedback - Iteration 2)

**User insight**: "The hashed IDs should come from getting the recipe details from populating it."

### Revised Root Cause

The craftableRecipes sync loop (useDataProvider.ts:183-211) creates craftable items with `hashedId: ''` hardcoded. However, each craftable has a corresponding recipe in the `recipes` array that knows what item it produces (`producesItemName`) and can know the produced item's hashedId (`producesItemHashedId`).

**Data analysis**:
- All 311 craftableRecipes match to recipes via `recipe.producesItemName === craftableRecipe.name`
- Currently only 35/311 recipes have `producesItemHashedId` populated (69 recipe rows due to tradable/untradable pairs)
- 276 recipes are missing `producesItemHashedId`

### The Fix Approach (Simpler Than Original Plan)

**Phase 1**: Update `populate-hashed-ids.ts` to also populate `producesItemHashedId` on recipe items when it processes them. When processing a recipe, search for the produced item by name and record its hashed ID.

**Phase 2**: Update the craftableRecipes sync loop to carry over `producesItemHashedId` from the matching recipe to the craftable's `hashedId` field (instead of hardcoding empty string).

**Phase 3**: Re-run populate script + verify export-to-defaults preserves hashedIds.

### Tickets to Close (No Longer Needed)
- imp-ivei (deterministic IDs) -- NOT needed. The core issue is not ID stability, it's that hashedId is never populated from the recipe.
- imp-n8d2 (investigation) -- DONE. Root cause is fully understood.
- imp-xi3d (export fix) -- Scope reduced. Export already works correctly; the issue is that hashedIds are empty at the source.

### Tickets to Revise
- imp-40gu (populate script) -- Still needed but with revised scope: populate producesItemHashedId on recipes, then use that in sync loop.
- imp-lg1a (tests) -- Still needed but simplified scope.

**2026-02-27T22:23:47Z**

## Revised Plan Summary (Iteration 2)

### Closed Tickets (no longer needed):
- imp-n8d2 [closed] - Investigation complete, root cause understood
- imp-ivei [closed] - Deterministic IDs not needed; hashedId comes from recipe data
- imp-xi3d [closed] - Export function works correctly; issue is upstream

### Active Tickets (2 remaining):
1. **imp-40gu [P1][open]** - Core fix: Populate craftable hashedIds from source recipes
   - Part 1: Update sync loop in useDataProvider.ts to copy producesItemHashedId from matching recipe
   - Part 2: Update populate-hashed-ids.ts to populate producesItemHashedId on recipes
   - Part 3: Re-run populate script to fill in missing 276 producesItemHashedId values
   - NO BLOCKERS - ready to implement

2. **imp-lg1a [P2][blocked by imp-40gu]** - Tests for the fix
   - 4 test cases covering hashedId population, fallback, export roundtrip, and preservation

### Key Files:
- /home/felix/idle-mmo-profiter/src/composables/useDataProvider.ts (lines 199-211 sync loop)
- /home/felix/idle-mmo-profiter/scripts/populate-hashed-ids.ts (recipe processing)

### Dependency: imp-40gu -> imp-lg1a (linear)

**2026-02-27T23:41:27Z**

Review: APPROVE. All 231 tests pass. The fix correctly populates craftable hashedId from recipe producesItemHashedId in both the startup sync loop and addCraftableRecipe(). Edge cases (no matching recipe, missing producesItemHashedId) gracefully fall back to empty string. Populate script correctly enhanced to backfill producesItemHashedId via API search. Minor suggestions: (1) test conditional guards (lines 499-502, 549) could silently become no-ops if test data changes — consider expect.assertions(n) or explicit skip; (2) the recipe-lookup logic is duplicated in two places — could be extracted into a helper for DRY.

**2026-02-27T23:41:41Z**

Review: APPROVED. All 231 tests passing. Minor suggestions: (1) add expect.assertions() to tests, (2) extract recipe-lookup into helper to reduce duplication. Both non-blocking.

**2026-02-27T23:43:56Z**

User feedback: Delete all craftables from defaults.json so they can be re-imported fresh with correct hashedIds from recipes.

**2026-02-27T23:44:44Z**

Removed all craftables from defaults.json for re-import

**2026-02-27T23:46:03Z**

User feedback: Craftables still showing in Market tab after clearing defaults.json. Need to investigate if they are cached in localStorage or another storage layer.

**2026-02-27T23:47:52Z**

User feedback: HashedIds are still missing on recreated craftables. The recipe lookup in the sync loop is failing. Need to investigate why.

**2026-02-28T13:16:24Z**

User will run populate-hashed-ids.ts script with API key later to fill in missing producesItemHashedId values. Code fix is in place and verified.
